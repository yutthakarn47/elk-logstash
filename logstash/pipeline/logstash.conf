input {
	stdin { codec => json }
	beats {
                port => 5044
                codec => plain {
                        charset => "UTF-8"
                }
	}
}

input {
	stdin { codec => json }
	beats {
                port => 5045
                codec => plain {
                        charset => "UTF-8"
                }
	}
}

filter {
	if [container][labels][com_docker_swarm_service_name] == 'nginx-pgslot-sit_reverse-proxy' or [container][labels][com_docker_swarm_service_name] == 'nginx-pgslot-uat_reverse-proxy' or [container][labels][com_docker_swarm_service_name] == 'nginx-pgslot-production_reverse-proxy' {
                grok {
			match => { 'message' => '\[%{HTTPDATE:timestamp}\] %{IPV4:ip} %{GREEDYDATA:http_host} "(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})" %{NUMBER:response} (?:%{NUMBER:bytes}|-) %{QS:referrer} %{QS:device} %{NUMBER:request_time:float} %{NUMBER:upstream_time} %{GREEDYDATA:body}' }
			#grok 403
                        match => { 'message' => '\[%{HTTPDATE:timestamp}\] %{IPV4:ip} %{GREEDYDATA:http_host} "(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})" %{NUMBER:response} (?:%{NUMBER:bytes}|-) %{QS:referrer} %{QS:device} %{NUMBER:upstream_time}' }
			#grok error
                        match => { 'message' => '(?<timestamp>%{YEAR}[./]%{MONTHNUM}[./]%{MONTHDAY} %{TIME}) \[%{LOGLEVEL:err_level}\] %{GREEDYDATA:err_message}' }
                        tag_on_failure => [ "failure" ] 
		}
	}
        
	else {
        if ([message] =~ "UnauthorizedError") {
                drop { }
        } 

        json {
                skip_on_invalid_json => true
                source => "message"
                target => "pm2_json"
        }

        # json {
        # 	skip_on_invalid_json => true
        # 	source => "body"
        # 	target => "body_json"
        # }

        mutate {
                convert => {
                        "request_time" => "float"
                }
                #gsub => ["log_message", "[\\]", ""]
        }

        json {
                skip_on_invalid_json => true
                source => "[pm2_json][message]"
                target => "parsed_json"
        }

        grok { 
                match => {'[parsed_json][url]' => '%{URIPROTO:uri_proto}://(?:%{URIHOST:uri_domain})?(?:%{URIPATHPARAM:uri_param})'}
        } 
	}
}

output {
        if "pgslot-docker-sit" in [tags] {
                elasticsearch {
                        index => "pgslot-docker-sit-%{+YYYY.MM.dd}"
                        hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                        user => "elastic"
                        password => "ambgam35!"
                }
        } else if "pgslot-docker-uat" in [tags] {
                elasticsearch {
                        index => "pgslot-docker-uat-%{+YYYY.MM.dd}"
                        hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                        user => "elastic"
                        password => "ambgam35!"
                }
        } else if "pgslot-docker-prod" in [tags] {
                if [container][labels][com_docker_swarm_service_name] == 'nginx-pgslot-production_reverse-proxy' {
					if [http_host] == 'angpow-prod.pgslot-api.com' or [http_host] == 'angpow-prod.pgslot-private.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-angpow-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'pgslot-web-api-prod.pgslot-api.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-web-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'third5.pgslot-api.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-auto-pg35-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'auto-transaction.pgslot-api.com' or [http_host] == 'auto-transaction.pgslot-private.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-auto-ambbo-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'auto-transaction-transfer.pgslot-api.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-auto-transfer-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'api-prod.pgslot-api.com' or [http_host] == 'api-prod.pgslot-private.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-core-api-%{[container][labels][com_docker_swarm_node_id]}-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'spf-api-prod.pgslot-api.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-spf-api-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'lotto-prod.pgslot-api.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-lotto-socket-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
					else if [http_host] == 'skt-prod.pgslot-api.com' or [http_host] == 'skt-prod.pgslot-private.com' {
							elasticsearch {
									index => "pgslot-prod-nginx-socket-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
                                        else {
							elasticsearch {
									index => "pgslot-prod-nginx-error-%{+YYYY.MM.dd}"
									hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
									user => "elastic"
									password => "ambgam35!"
							}
					}
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-core-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-core-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-angpow-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-angpow-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-auto-ambbo-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-auto-ambbo-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-auto-pg35-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-auto-pg35-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-auto-transfer-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-auto-transfer-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-game-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-game-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-lotto-socket-production_socket' {
                        elasticsearch {
                                index => "pgslot-prod-lotto-socket-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-socket-interval-production_socket' {
                        elasticsearch {
                                index => "pgslot-prod-interval-socket-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-socket-production_socket' {
                        elasticsearch {
                                index => "pgslot-prod-socket-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-web-api-production_api' {
                        elasticsearch {
                                index => "pgslot-prod-web-api-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
                else if [container][labels][com_docker_swarm_service_name] == 'pgslot-schedule-loopelastic-production_api' {
                        elasticsearch {
                                index => "pgslot-schedule-loopelastic-%{+YYYY.MM.dd}"
                                hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                                user => "elastic"
                                password => "ambgam35!"
                        }
                }
        } else {
                elasticsearch {
                        index => "etc-%{+YYYY.MM.dd}"
                        hosts => ["10.10.10.87:9200", "10.10.10.87:9201", "10.10.10.87:9202"]
                        user => "elastic"
                        password => "ambgam35!"
                }
        }
}